# Архитектура системы

## Обзор архитектуры

Банковская рекомендательная система построена по многоуровневой архитектуре с четким разделением ответственности между компонентами. Система использует микросервисный подход в рамках монолитного Spring Boot приложения.

## Диаграмма компонентов

![Component Diagram](../docs/images/component-diagram.png)

### Описание компонентов

#### 1. Внешние интерфейсы
- **REST API Controller** - обработка HTTP запросов для рекомендаций и управления
- **Telegram Bot Controller** - взаимодействие с Telegram Bot API
- **Management Controller** - endpoints для управления (сброс кэша, информация)

#### 2. Бизнес-логика
- **Recommendation Service** - основной сервис рекомендаций
- **Rule Management Service** - управление динамическими правилами
- **Statistics Service** - сбор и предоставление статистики
- **Telegram Bot Service** - бизнес-логика для Telegram бота

#### 3. Доступ к данным
- **Transaction Repository** - доступ к транзакционным данным (read-only)
- **Rule Repository** - CRUD операции для динамических правил
- **Statistics Repository** - хранение статистики срабатываний

#### 4. Инфраструктура
- **Cache Manager** - управление кэшированием (Caffeine)
- **Database Connector** - подключение к H2 базам данных
- **External API Client** - взаимодействие с внешними сервисами

#### 5. Внешние системы
- **H2 Transaction Database** - база транзакций (только для чтения)
- **H2 Rules Database** - база динамических правил (чтение/запись)
- **Telegram API** - платформа для Telegram бота
- **Monitoring System** - сбор метрик и логов

## Взаимодействие с внешними системами

### Входящие вызовы:
1. **HTTP запросы** от клиентов через REST API
2. **Telegram сообщения** через Telegram Bot API
3. **Управляющие команды** от менеджеров банка

### Исходящие вызовы:
1. **Запросы к БД** для получения транзакционных данных
2. **Вызовы Telegram API** для отправки сообщений
3. **Запись статистики** в базу данных

## Диаграмма деятельности (Activity Diagram)

![Activity Diagram](../docs/images/activity-diagram.png)

### Алгоритм выдачи рекомендаций

```mermaid
graph TD
    A[Запрос рекомендаций] --> B{Тип запроса}
    B -->|API по userId| C[Получить пользователя по ID]
    B -->|Telegram по username| D[Найти пользователя по имени]
    
    C --> E[Проверить статические правила]
    D --> E
    
    E --> F[Загрузить активные динамические правила]
    F --> G{Есть кэшированные результаты?}
    G -->|Да| H[Использовать кэш]
    G -->|Нет| I[Выполнить SQL запросы правил]
    
    H --> J[Собрать подходящие рекомендации]
    I --> K[Закэшировать результаты] --> J
    
    J --> L[Увеличить счетчики статистики]
    L --> M[Вернуть рекомендации клиенту]
    
    E --> N[Правило 1: Invest 500]
    E --> O[Правило 2: Top Saving]
    E --> P[Правило 3: Простой кредит]
    
    N --> Q{Условия выполнены?}
    O --> R{Условия выполнены?}
    P --> S{Условия выполнены?}
    
    Q -->|Да| T[Добавить в рекомендации]
    R -->|Да| U[Добавить в рекомендации]
    S -->|Да| V[Добавить в рекомендации]
    
    T --> J
    U --> J
    V --> J
Детализация алгоритма:
Получение входных данных

Для API: userId напрямую

Для Telegram: поиск userId по username

Проверка статических правил

Правило 1: Invest 500 (ТЗ-1)

Правило 2: Top Saving (ТЗ-1)

Правило 3: Простой кредит (ТЗ-1)

Каждое правило проверяется независимо

Обработка динамических правил

Загрузка всех активных правил из БД

Проверка кэша для каждого правила

При отсутствии в кэше - выполнение SQL запроса

Кэширование результатов на 5 минут

Формирование ответа

Объединение результатов статических и динамических правил

Учет приоритетов и дубликатов

Форматирование для соответствующего клиента (API/Telegram)

Сбор статистики

Инкремент счетчиков для сработавших правил

Логирование для аналитики

Диаграмма вариантов использования
https://../docs/images/use-case-diagram.png

Акторы и их возможности:
Актор 1: Менеджер банка
Управление динамическими правилами (CRUD операции)

Просмотр статистики срабатываний правил

Сброс кэша рекомендаций

Мониторинг работы системы

Актор 2: Клиент банка
Получение рекомендаций через REST API

Получение рекомендаций через Telegram бота

Просмотр истории рекомендаций (если реализовано)

Актор 3: Внешняя система
Сбор метрик для мониторинга

Интеграция с другими системами банка

Автоматический сброс кэша по расписанию

Актор 4: Telegram Bot
Прием команд от пользователей

Отправка рекомендаций в чат

Обработка ошибок и валидация ввода

Технические детали реализации
Кэширование
java
@Cacheable(value = "ruleResults", key = "#ruleId")
public Set<UUID> getUsersForRule(UUID ruleId) {
    // Выполнение SQL запроса правила
}
Стратегия кэширования:

Тип: In-memory (Caffeine)

TTL: 5 минут

Размер: до 1000 записей на правило

Инвалидация: при изменении/удалении правила

Обработка транзакций
Read-only доступ к основной БД транзакций

Read-write доступ к БД правил и статистики

Оптимизированные SQL запросы с использованием индексов

Обработка ошибок
Глобальный обработчик исключений (@ControllerAdvice)

Структурированное логирование (JSON форматы)

Graceful degradation при недоступности компонентов

Масштабируемость
Вертикальное масштабирование
Увеличение памяти JVM для кэша

Настройка пулов соединений с БД

Оптимизация SQL запросов

Горизонтальное масштабирование
Статус: требует доработки

Планируется: распределенный кэш (Redis)

Планируется: репликация БД правил

Безопасность
Текущая реализация
Отсутствует аутентификация (внутренний контур банка)

Валидация входных данных (UUID, SQL injection protection)

Логирование всех операций

Рекомендации для production
Добавить JWT аутентификацию

Реализовать ролевую модель (менеджер/клиент)

Настроить HTTPS

Добавить rate limiting

Заключение
Архитектура системы обеспечивает:

Гибкость через динамические правила

Производительность через многоуровневое кэширование

Масштабируемость через четкое разделение компонентов

Поддерживаемость через полную документацию и тестирование

Система готова к использованию в production среде после реализации рекомендаций по безопасности.